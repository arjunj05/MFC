name: Warning Check

on: [push, pull_request, workflow_dispatch]

jobs:
  check-warnings:
    name: Check for New Warnings
    runs-on: ubuntu-latest
    timeout-minutes: 60 
    steps:
    - name: Checkout code from PR branch
      uses: actions/checkout@v4
      with:
        path: pr

    - name: Checkout code from base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        path: base

    - name: Build on base branch
      run: |
        cd $GITHUB_WORKSPACE/base
        ./mfc.sh build > out_base.txt 2>&1

    - name: Build on PR branch
      run: |
        cd $GITHUB_WORKSPACE/pr
        ./mfc.sh build > out_pr.txt 2>&1

    - name: Compare Warnings
      run: |
        grep '\-W' $GITHUB_WORKSPACE/base/out_base.txt > warnings_base.txt
        grep '\-W' $GITHUB_WORKSPACE/pr/out_pr.txt > warnings_pr.txt
        comm -23 <(sort warnings_pr.txt) <(sort warnings_base.txt) > new_warnings.txt
        if [ -s new_warnings.txt ]; then
          echo "New warnings introduced!"
          cat new_warnings.txt
          exit 1
        else
          echo "No new warnings introduced."
        fi
